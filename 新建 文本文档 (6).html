<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>真人聊天室</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:#ededed;height:100vh;display:flex;flex-direction:column;}
        .container{flex:1;display:flex;flex-direction:column;max-width:600px;margin:0 auto;width:100%;background:#fff;box-shadow:0 0 10px rgba(0,0,0,.1);}
        .header{background:#07c160;color:#fff;padding:12px 16px;font-size:18px;font-weight:500;text-align:center;position:relative;}
        .messages{flex:1;overflow-y:auto;padding:10px;background:#f5f5f5;}
        .message{margin-bottom:15px;display:flex;align-items:flex-end;}
        .message.me{flex-direction:row-reverse;}
        .avatar{width:40px;height:40px;border-radius:4px;background:#07c160;color:#fff;display:flex;align-items:center;justify-content:center;font-size:14px;margin:0 10px;flex-shrink:0;}
        .message.me .avatar{background:#07c160;}
        .content{max-width:65%;background:#fff;padding:10px 12px;border-radius:6px;font-size:15px;line-height:1.4;box-shadow:0 1px 3px rgba(0,0,0,.08);}
        .message.me .content{background:#95ec69;}
        .time{font-size:11px;color:#999;margin:0 10px;white-space:nowrap;}
        .input-area{border-top:1px solid #e5e5e5;background:#fff;display:flex;align-items:center;padding:8px 12px;}
        .input-area input{flex:1;border:none;outline:none;font-size:16px;padding:8px 10px;}
        .input-area button{background:#07c160;color:#fff;border:none;padding:8px 16px;border-radius:4px;font-size:14px;margin-left:10px;cursor:pointer;}
        .input-area button:disabled{background:#ccc;}
        .mask{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:999;}
        .modal{background:#fff;border-radius:8px;padding:24px;width:300px;text-align:center;}
        .modal h3{margin-bottom:16px;font-size:18px;}
        .modal input{width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;margin-bottom:16px;font-size:14px;}
        .modal button{width:100%;padding:10px;background:#07c160;color:#fff;border:none;border-radius:4px;font-size:14px;cursor:pointer;}
        .modal button:hover{opacity:.9;}
        .hidden{display:none;}
    </style>
</head>
<body>
    <!-- 邀请码遮罩 -->
    <div class="mask" id="mask">
        <div class="modal">
            <h3>输入邀请码</h3>
            <input id="codeInput" type="text" placeholder="邀请码" maxlength="9">
            <button onclick="checkCode()">进入聊天室</button>
            <p style="margin-top:10px;font-size:12px;color:#999;">邀请码：123456789</p>
        </div>
    </div>

    <!-- 设置网名遮罩 -->
    <div class="mask hidden" id="nameMask">
        <div class="modal">
            <h3>设置您的网名</h3>
            <input id="nameInput" type="text" placeholder="输入网名" maxlength="12">
            <button onclick="setName()">开始聊天</button>
        </div>
    </div>

    <!-- 聊天界面 -->
    <div class="container hidden" id="chatWrap">
        <div class="header">真人聊天室</div>
        <div class="messages" id="msgBox"></div>
        <div class="input-area">
            <input id="msgInput" type="text" placeholder="输入消息..." maxlength="500">
            <button id="sendBtn" onclick="sendMsg()">发送</button>
        </div>
    </div>

    <script>
        /* 简单本地存储：所有数据存于 localStorage，同一浏览器多标签共享 */
        const STORAGE_KEY = 'chat_real_people';
        const INVITE_CODE = '123456789';
        let myName = '';

        /* 首次进入检查邀请码 */
        function checkCode() {
            const val = document.getElementById('codeInput').value.trim();
            if (val === INVITE_CODE) {
                document.getElementById('mask').classList.add('hidden');
                document.getElementById('nameMask').classList.remove('hidden');
                document.getElementById('nameInput').focus();
            } else {
                alert('邀请码错误');
            }
        }

        /* 设置网名 */
        function setName() {
            const input = document.getElementById('nameInput');
            const name = input.value.trim();
            if (!name) {
                alert('请输入网名');
                return;
            }
            myName = name;
            document.getElementById('nameMask').classList.add('hidden');
            document.getElementById('chatWrap').classList.remove('hidden');
            initChat();
        }

        /* 初始化聊天 */
        function initChat() {
            loadHistory();
            window.addEventListener('storage', loadHistory); // 监听其他标签页变化
            document.getElementById('msgInput').addEventListener('keydown', e => {
                if (e.key === 'Enter') sendMsg();
            });
        }

        /* 读取历史消息 */
        function loadHistory() {
            const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const box = document.getElementById('msgBox');
            box.innerHTML = '';
            data.forEach(m => appendMsgDom(m.name, m.text, m.time, m.name === myName));
            box.scrollTop = box.scrollHeight;
        }

        /* 发送消息 */
        function sendMsg() {
            const input = document.getElementById('msgInput');
            const text = input.value.trim();
            if (!text) return;
            input.value = '';
            const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const msg = { name: myName, text, time: Date.now() };
            data.push(msg);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            appendMsgDom(myName, text, msg.time, true);
            document.getElementById('msgBox').scrollTop = document.getElementById('msgBox').scrollHeight;
        }

        /* 追加单条消息到页面 */
        function appendMsgDom(name, text, time, isMe) {
            const box = document.getElementById('msgBox');
            const div = document.createElement('div');
            div.className = 'message ' + (isMe ? 'me' : '');
            const date = new Date(time);
            const timeStr = date.getHours().toString().padStart(2, '0') + ':' + date.getMinutes().toString().padStart(2, '0');
            div.innerHTML = `
                <div class="avatar">${name.slice(-2)}</div>
                <div class="content">${escapeHtml(text)}</div>
                <div class="time">${timeStr}</div>
            `;
            box.appendChild(div);
        }

        /* 简单转义防注入 */
        function escapeHtml(str) {
            return str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
        }
    </script>
</body>
</html>